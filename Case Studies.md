## Promo Codes On Scale

You need to design the server of a web page, which sells a product. The web page has a lot of visitors - more than 1 000 000 per month. The marketing team wants you to add a promo code, which is only for the first 10 000 people who claim it. The promo code will be available at a specific date and time. For example, October 10th, 12:00 PM. All the site's users will receive an e-mail newsletter about the promotion two days prior to that date so everyone knows about the code and the huge discount. Lots of people (more than 100 000) will start refreshing the site to try to purchase the product at the same time. How would you handle the server logic? How would you guarantee that exactly 10 000 people will receive the discount?

### Promo Codes On Scale Answer

There are two problems with the above requirements in a typical solution:

If we use a normal database, it may start returning timeouts from the huge load. Even if the database does not block, it will be difficult to check 10 000 promo codes exactly because of the asynchronous nature of the requests. We can use two approaches to fulfill the business requirements:

We can use atomic in-memory storage to save all the people who try to claim the promo codes. There are no chances of timeouts with such a persistence option. After we have more than 10 000 entries saved, we will just extract the first 10 000 of them and store them in the real database. We may create the in-memory storage by ourselves or we may use Redis as a third-party solution. If you are not familiar with Redis - I have a live class about it here in my mentorship feed. Another approach is to use an asynchronous queue with two threads. One thread will write to the queue, and another will read from it. The writing thread will push as many user requests as it can until there are more than 10 000 saved. The reading thread will take one entry at a time and store it in the database. It will do it in a slow and convenient manner so that the real database will not be overloaded with queries. If you are not familiar with multithreading - I have a step-by-step practical guidebook about it here is my mentorship feed. No matter the approach, we need to visualize a loading screen to the user, while the promo codes are processed. Then the browser will periodically poll the server to validate whether the user receives a discount or not.
